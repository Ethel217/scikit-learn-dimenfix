<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>t-SNE Scatter Plot with Pie Charts</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    .scatter-plot {
      position: relative;
      width: 800px;
      height: 600px;
    }
    .pie-chart {
      position: absolute;
    }
  </style>
</head>
<body>
  <div class="scatter-plot" id="scatter-plot"></div>
  
  <script>
    // Load the tsne and ratios data
    Promise.all([
      d3.json('embedding.json'),
      d3.json('ratios.json')
    ]).then(([tsneData, ratiosData]) => {
      // Combine the t-SNE coordinates with the ratios
      tsneData.forEach((point, index) => {
        point.ratios = ratiosData[index]; // Assuming the same index for matching
      });

      // Now tsneData contains both the coordinates and the ratio for each point
      renderScatterPlotWithPieCharts(tsneData);
    });

    // Function to render scatter plot and pie charts
    function renderScatterPlotWithPieCharts(tsneData) {
      // Set up the SVG container
      const svgWidth = 800, svgHeight = 600;
      const svg = d3.select("#scatter-plot")
                    .append("svg")
                    .attr("width", svgWidth)
                    .attr("height", svgHeight);

      // Define the color scale for the pie chart
      const colorScale = d3.scaleOrdinal()
                           .domain([0, 1, 2])
                           .range(["#FF6347", "#4682B4", "#32CD32"]); // Red, Blue, Green

      // Function to generate pie chart SVG for each point
      function generatePieChart(ratios) {
        const pie = d3.pie().value(d => d)(ratios);
        const arc = d3.arc().innerRadius(10).outerRadius(20);  // Small pie chart

        return d3.select(document.createElementNS('http://www.w3.org/2000/svg', 'svg'))
                 .attr("width", 40)
                 .attr("height", 40)
                 .selectAll("path")
                 .data(pie)
                 .enter()
                 .append("path")
                 .attr("d", arc)
                 .attr("fill", d => colorScale(d.index));
      }

      // Render the points and pie charts
      tsneData.forEach((point) => {
        // Add scatter plot points
        svg.append("circle")
           .attr("cx", point.x * svgWidth)  // Scale to fit the SVG container
           .attr("cy", point.y * svgHeight)
           .attr("r", 5)
           .attr("fill", "#000");

        // Generate and position pie charts next to the points
        const pieChart = generatePieChart(point.ratios);
        svg.node().appendChild(pieChart.node());
        d3.select(pieChart.node())
          .attr("x", point.x * svgWidth - 20)  // Center the pie chart around the point
          .attr("y", point.y * svgHeight - 20); // Adjust position
      });
    }
  </script>
</body>
</html>
